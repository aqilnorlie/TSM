<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sinar Warisan | Dashboard</title>

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="../../plugins/fontawesome-free/css/all.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- Tempusdominus Bootstrap 4 -->
  <link rel="stylesheet" href="../../plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css">
  <!-- iCheck -->
  <link rel="stylesheet" href="../../plugins/icheck-bootstrap/icheck-bootstrap.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="../../dist/css/adminlte.min.css">
  <!-- overlayScrollbars -->
  <link rel="stylesheet" href="../../plugins/overlayScrollbars/css/OverlayScrollbars.min.css">
  <!-- Daterange picker -->
  <link rel="stylesheet" href="../../plugins/daterangepicker/daterangepicker.css">





</head>

<body class="hold-transition dark-mode sidebar-mini layout-fixed">
  <script>
    (function () {
      // Check for login
      const user = localStorage.getItem('user');
      if (!user) {
        window.location.href = '../login.html';
      }

      // Intercept fetch to handle 401 and specific error messages
      const originalFetch = window.fetch;
      window.fetch = function () {
        return originalFetch.apply(this, arguments).then(async response => {
          if (response.status === 401) {
            window.location.href = '../login.html';
            return response;
          }

          // Check for specific JSON error message
          const clone = response.clone();
          try {
            const data = await clone.json();
            if (data.error === "UNAUTHORIZED" || data.message === "Please login first") {
              window.location.href = '../login.html';
            }
          } catch (e) {
            // Ignore if not JSON
          }
          return response;
        });
      };
    })();
  </script>
  <div class="wrapper">

    <!-- Preloader -->
    <div class="preloader flex-column justify-content-center align-items-center">
      <img class="animation__shake" src="../../dist/img/AdminLTELogo.png" alt="AdminLTELogo" height="60" width="60">
    </div>

    <!-- Navbar -->
    <div id="navbar-container"></div>
    <!-- /.navbar -->

    <!-- Main Sidebar Container -->
    <!-- Main Sidebar Container -->
    <div id="sidebar-container"></div>

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
      <!-- Content Header (Page header) -->
      <div class="content-header">
        <div class="container-fluid">
          <div class="row mb-2">
            <div class="col-sm-6">
              <h1 class="m-0">Dashboard</h1>
            </div><!-- /.col -->
            <div class="col-sm-6">
              <ol class="breadcrumb float-sm-right">
                <li class="breadcrumb-item"><a href="#">Home</a></li>
                <li class="breadcrumb-item active">Dashboard v1</li>
              </ol>
            </div><!-- /.col -->
          </div><!-- /.row -->
        </div><!-- /.container-fluid -->
      </div>
      <!-- /.content-header -->

      <!-- Main content -->
      <section class="content">
        <div class="container-fluid">
          <!-- Small boxes (Stat box) -->
          <div class="row">
            <div class="col-lg-3 col-6">
              <!-- small box -->
              <div class="small-box bg-success">
                <div class="inner">
                  <h3 id="total-teachers">0</h3>

                  <p>Total Teachers</p>
                </div>
                <div class="icon">
                  <i class="fas fa-chalkboard-teacher"></i>
                </div>

              </div>
            </div>
            <!-- ./col -->
            <div class="col-lg-3 col-6">
              <!-- small box -->
              <div class="small-box bg-info">
                <div class="inner">
                  <h3 id="total-students">0</h3>

                  <p>Total Students</p>
                </div>
                <div class="icon">
                  <i class="fas fa-user-graduate"></i>
                </div>

              </div>
            </div>
            <!-- ./col -->
            <div class="col-lg-3 col-6">
              <!-- small box -->
              <div class="small-box bg-warning">
                <div class="inner">
                  <h3 id="total-subjects">0</h3>

                  <p>Total Subjects</p>
                </div>
                <div class="icon">
                  <i class="fas fa-book"></i>
                </div>

              </div>
            </div>
            <!-- ./col -->
            <div class="col-lg-3 col-6">
              <!-- small box -->
              <div class="small-box bg-danger">
                <div class="inner">
                  <h3 id="total-income">0</h3>

                  <p>Total Income</p>
                </div>
                <div class="icon">
                  <i class="fas fa-dollar-sign"></i>
                </div>

              </div>
            </div>
            <!-- ./col -->
          </div>
          <!-- /.row -->
          <!-- Main row -->
          <div class="row">
            <div class="col-md-6">
              <div class="card card-primary">
                <div class="card-header">
                  <h3 class="card-title">Total Student per Month</h3>
                  <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                      <i class="fas fa-minus"></i>
                    </button>
                    <button type="button" class="btn btn-tool" data-card-widget="remove">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
                <div class="card-body">
                  <div class="chart">
                    <canvas id="studentChart"
                      style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <!-- /.col (LEFT) -->

            <!-- Total Teacher Chart -->
            <div class="col-md-6">
              <div class="card card-success">
                <div class="card-header">
                  <h3 class="card-title">Total Teacher per Month</h3>
                  <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                      <i class="fas fa-minus"></i>
                    </button>
                    <button type="button" class="btn btn-tool" data-card-widget="remove">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
                <div class="card-body">
                  <div class="chart">
                    <canvas id="teacherChart"
                      style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <!-- /.col (RIGHT) -->
          </div>
          <!-- /.row -->

          <div class="row">
            <!-- Total Payment per Month Chart -->
            <div class="col-md-12">
              <div class="card card-info">
                <div class="card-header">
                  <h3 class="card-title">Total Payment per Month</h3>
                  <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                      <i class="fas fa-minus"></i>
                    </button>
                    <button type="button" class="btn btn-tool" data-card-widget="remove">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
                <div class="card-body">
                  <div class="chart">
                    <canvas id="paymentChart"
                      style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <!-- /.row (main row) -->
          </div><!-- /.container-fluid -->
      </section>
      <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->
    <footer class="main-footer">
      <strong>Copyright &copy; 2025-2030 <a href="">Sinar Warisan</a>.</strong>
      All rights reserved.
      <div class="float-right d-none d-sm-inline-block">
        <b>Version</b> 3.2.0
      </div>
    </footer>

    <!-- Control Sidebar -->
    <aside class="control-sidebar control-sidebar-dark">
      <!-- Control sidebar content goes here -->
    </aside>
    <!-- /.control-sidebar -->
  </div>
  <!-- ./wrapper -->

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      /* ChartJS
       * -------
       * Here we will create a few charts using ChartJS
       */

      // Get context with jQuery - using jQuery's .get() method.
      var studentChartCanvas = $('#studentChart').get(0).getContext('2d')
      var teacherChartCanvas = $('#teacherChart').get(0).getContext('2d')
      var paymentChartCanvas = $('#paymentChart').get(0).getContext('2d')

      //-------------
      //- BAR CHART -
      //-------------
      var barChartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        datasetFill: false,
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero: true
            }
          }]
        }
      }

      // Fetch Student Data and Render Chart
      fetch('http://localhost:8081/api/student/list', { credentials: 'include' })
        .then(response => response.json())
        .then(data => {
          let students = [];
          if (Array.isArray(data)) {
            students = data;
          } else if (data.data && Array.isArray(data.data)) {
            students = data.data;
          }

          // Initialize counts for 12 months
          let monthlyCounts = new Array(12).fill(0);

          students.forEach(student => {
            if (student.createdAt) {
              const date = new Date(student.createdAt);
              const month = date.getMonth(); // 0-11
              if (month >= 0 && month < 12) {
                monthlyCounts[month]++;
              }
            }
          });

          var studentData = {
            labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
            datasets: [
              {
                label: 'Total Students',
                backgroundColor: 'rgba(60,141,188,0.9)',
                borderColor: 'rgba(60,141,188,0.8)',
                pointRadius: false,
                pointColor: '#3b8bba',
                pointStrokeColor: 'rgba(60,141,188,1)',
                pointHighlightFill: '#fff',
                pointHighlightStroke: 'rgba(60,141,188,1)',
                data: monthlyCounts
              }
            ]
          }

          new Chart(studentChartCanvas, {
            type: 'bar',
            data: studentData,
            options: barChartOptions
          })
        })
        .catch(error => console.error('Error fetching student data:', error));

      // Fetch Teacher Data and Render Chart
      fetch('http://localhost:8081/api/teacher/list', { credentials: 'include' })
        .then(response => response.json())
        .then(data => {
          let teachers = [];
          if (Array.isArray(data)) {
            teachers = data;
          } else if (data.data && Array.isArray(data.data)) {
            teachers = data.data;
          }

          // Initialize counts for 12 months
          let monthlyCounts = new Array(12).fill(0);

          teachers.forEach(teacher => {
            if (teacher.createdAt) {
              const date = new Date(teacher.createdAt);
              const month = date.getMonth(); // 0-11
              if (month >= 0 && month < 12) {
                monthlyCounts[month]++;
              }
            }
          });

          var teacherData = {
            labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
            datasets: [
              {
                label: 'Total Teachers',
                backgroundColor: 'rgba(210, 214, 222, 1)',
                borderColor: 'rgba(210, 214, 222, 1)',
                pointRadius: false,
                pointColor: 'rgba(210, 214, 222, 1)',
                pointStrokeColor: '#c1c7d1',
                pointHighlightFill: '#fff',
                pointHighlightStroke: 'rgba(220,220,220,1)',
                data: monthlyCounts
              }
            ]
          }

          new Chart(teacherChartCanvas, {
            type: 'bar',
            data: teacherData,
            options: barChartOptions
          })
        })
        .catch(error => console.error('Error fetching teacher data:', error));

      //-------------
      //- LINE CHART -
      //-------------
      var lineChartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        datasetFill: false,
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero: true
            }
          }]
        }
      }

      // Fetch Payment Data and Render Chart
      fetch('http://localhost:8081/api/payment/list', { credentials: 'include' })
        .then(response => response.json())
        .then(data => {
          let payments = [];
          if (Array.isArray(data)) {
            payments = data;
          } else if (data.data && Array.isArray(data.data)) {
            payments = data.data;
          }

          // Initialize sums for 12 months
          let monthlySums = new Array(12).fill(0);

          payments.forEach(payment => {
            if (payment.date && payment.amount) {
              const date = new Date(payment.date);
              const month = date.getMonth(); // 0-11
              if (month >= 0 && month < 12) {
                monthlySums[month] += parseFloat(payment.amount);
              }
            }
          });

          var paymentData = {
            labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
            datasets: [
              {
                label: 'Total Payment ($)',
                backgroundColor: 'rgba(0, 192, 239, 0.5)',
                borderColor: 'rgba(0, 192, 239, 1)',
                pointRadius: 3,
                pointBackgroundColor: 'rgba(0, 192, 239, 1)',
                pointBorderColor: 'rgba(0, 192, 239, 1)',
                pointHoverRadius: 5,
                pointHoverBackgroundColor: 'rgba(0, 192, 239, 1)',
                pointHoverBorderColor: 'rgba(0, 192, 239, 1)',
                fill: true,
                data: monthlySums
              }
            ]
          }

          new Chart(paymentChartCanvas, {
            type: 'line',
            data: paymentData,
            options: lineChartOptions
          })
        })
        .catch(error => console.error('Error fetching payment data:', error));

      //----------------
      //- STAT BOXES -
      //----------------

      // Fetch Total Teachers
      fetch('http://localhost:8081/api/teacher/list', { credentials: 'include' })
        .then(response => response.json())
        .then(data => {
          let count = 0;
          if (Array.isArray(data)) {
            count = data.length;
          } else if (data.data && Array.isArray(data.data)) {
            count = data.data.length;
          }
          document.getElementById('total-teachers').innerText = count;
        })
        .catch(error => console.error('Error fetching teacher count:', error));

      // Fetch Total Students
      fetch('http://localhost:8081/api/student/list', { credentials: 'include' })
        .then(response => response.json())
        .then(data => {
          let count = 0;
          if (Array.isArray(data)) {
            count = data.length;
          } else if (data.data && Array.isArray(data.data)) {
            count = data.data.length;
          }
          document.getElementById('total-students').innerText = count;
        })
        .catch(error => console.error('Error fetching student count:', error));

      // Fetch Total Subjects
      fetch('http://localhost:8081/api/subject/list', { credentials: 'include' })
        .then(response => response.json())
        .then(data => {
          let count = 0;
          if (Array.isArray(data)) {
            count = data.length;
          } else if (data.data && Array.isArray(data.data)) {
            count = data.data.length;
          }
          document.getElementById('total-subjects').innerText = count;
        })
        .catch(error => console.error('Error fetching subject count:', error));

      // Fetch Total Income (reuse payment data logic if possible, or fetch again)
      // Since we already fetch payments for the chart, we could technically optimize, 
      // but for simplicity and separation of concerns, we'll fetch or just calculate here.
      // Actually, let's just fetch again to be clean, or we can move the logic.
      // Let's fetch again to ensure this block is standalone.
      fetch('http://localhost:8081/api/payment/list', { credentials: 'include' })
        .then(response => response.json())
        .then(data => {
          let payments = [];
          if (Array.isArray(data)) {
            payments = data;
          } else if (data.data && Array.isArray(data.data)) {
            payments = data.data;
          }

          let totalIncome = 0;
          payments.forEach(payment => {
            if (payment.amount) {
              totalIncome += parseFloat(payment.amount);
            }
          });

          // Format currency
          const formattedIncome = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD'
          }).format(totalIncome);

          document.getElementById('total-income').innerText = formattedIncome;
        })
        .catch(error => console.error('Error fetching income:', error));
    });
  </script>

  <!-- jQuery -->
  <script src="../../plugins/jquery/jquery.min.js"></script>
  <!-- jQuery UI 1.11.4 -->
  <script src="../../plugins/jquery-ui/jquery-ui.min.js"></script>
  <!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
  <script>
    $.widget.bridge('uibutton', $.ui.button)
  </script>
  <!-- Bootstrap 4 -->
  <!-- ChartJS -->
  <script src="../../plugins/chart.js/Chart.min.js"></script>
  <!-- daterangepicker -->
  <script src="../../plugins/moment/moment.min.js"></script>
  <script src="../../plugins/daterangepicker/daterangepicker.js"></script>
  <!-- Tempusdominus Bootstrap 4 -->
  <script src="../../plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
  <!-- Summernote -->
  <script src="../../plugins/summernote/summernote-bs4.min.js"></script>
  <!-- overlayScrollbars -->
  <script src="../../plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
  <!-- AdminLTE App -->
  <script src="../../dist/js/adminlte.js"></script>

  <script>
    $(function () {
      // Load Sidebar
      $("#sidebar-container").load("sidebar.html", function () {
        $("#nav-dashboard").addClass("active");
      });
      // Load Navbar
      $("#navbar-container").load("navbar.html");
    });
  </script>
</body>

</html>