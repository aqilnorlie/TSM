<!DOCTYPE html>
<!--
This is a starter template page. Use this page to start your new project from
scratch. This page gets rid of all links and provides the needed markup only.
-->
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AdminLTE 3 | Starter</title>

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="../../plugins/fontawesome-free/css/all.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="../../dist/css/adminlte.min.css">
</head>

<body class="hold-transition dark-mode sidebar-mini">
  <div class="wrapper">

    <!-- Navbar -->
    <div id="navbar-container"></div>
    <!-- /.navbar -->

    <!-- Main Sidebar Container -->
    <div id="sidebar-container"></div>
    <!-- /.sidebar -->
    </aside>

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
      <!-- Content Header (Page header) -->
      <div class="content-header">
        <div class="container-fluid">
          <div class="row mb-2">
            <div class="col-sm-6">
              <h1 class="m-0">Starter Page</h1>
            </div><!-- /.col -->
            <div class="col-sm-6">
              <ol class="breadcrumb float-sm-right">
                <li class="breadcrumb-item"><a href="#">Home</a></li>
                <li class="breadcrumb-item active">Starter Page</li>
              </ol>
            </div><!-- /.col -->
          </div><!-- /.row -->
        </div><!-- /.container-fluid -->
      </div>
      <!-- /.content-header -->

      <!-- Main content -->
      <div class="content">
        <div class="container-fluid">
          <div class="row">
            <div class="col-12">
              <div class="card card-primary shadow-lg border-0 rounded-lg">
                <div class="card-header bg-gradient-primary text-white rounded-top">
                  <h3 class="card-title font-weight-bold"><i class="fas fa-file-invoice-dollar mr-2"></i> Record Student
                    Payment</h3>
                </div>
                <!-- /.card-header -->
                <!-- form start -->
                <form id="payment-form">
                  <div class="card-body p-5">
                    <div class="form-group">
                      <label for="studentSearchInput" class="font-weight-medium">Student Name</label>
                      <div class="input-group mb-3 position-relative">
                        <div class="input-group-prepend">
                          <span class="input-group-text bg-light border-right-0"><i
                              class="fas fa-user-graduate text-success"></i></span>
                        </div>
                        <input type="text" class="form-control border-left-0" id="studentSearchInput"
                          placeholder="Type to search student..." autocomplete="off">
                        <input type="hidden" id="studentId" required>
                        <div id="studentSuggestions" class="suggestions-list"></div>
                      </div>
                    </div>
                    <div class="form-group">
                      <label for="classSubject" class="font-weight-medium">Subject</label>
                      <div class="input-group mb-3">
                        <div class="input-group-prepend">
                          <span class="input-group-text bg-light border-right-0"><i
                              class="fas fa-book-open text-info"></i></span>
                        </div>
                        <textarea class="form-control border-left-0" id="classSubject" rows="3"
                          placeholder="Auto-filled from Student" disabled></textarea>
                      </div>
                    </div>

                    <div class="form-group">
                      <label for="amount" class="font-weight-medium">Amount (RM)</label>
                      <div class="input-group mb-3">
                        <div class="input-group-prepend">
                          <span class="input-group-text bg-light border-right-0"><i
                              class="fas fa-money-bill-wave text-warning"></i></span>
                        </div>
                        <input type="number" class="form-control border-left-0" id="amount"
                          placeholder="Auto-calculated" readonly required>
                      </div>
                    </div>
                    <div class="form-group">
                      <label for="paymentDate" class="font-weight-medium">Payment Date</label>
                      <div class="input-group mb-3">
                        <div class="input-group-prepend">
                          <span class="input-group-text bg-light border-right-0"><i
                              class="far fa-calendar-alt text-danger"></i></span>
                        </div>
                        <input type="date" class="form-control border-left-0" id="paymentDate" required>
                      </div>
                    </div>
                  </div>
                  <!-- /.card-body -->

                  <div class="card-footer bg-white border-top-0 text-right pb-4 pr-5">
                    <button type="button" class="btn btn-primary btn-lg px-5 shadow-sm rounded-pill"
                      id="donePaymentBtn">
                      <i class="fas fa-check-circle mr-2"></i> Done Payment
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <!-- /.row -->
        </div><!-- /.container-fluid -->
      </div>
      <!-- /.content -->

      <!-- Receipt Modal -->
      <div class="modal fade" id="receiptModal" tabindex="-1" role="dialog" aria-labelledby="receiptModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="receiptModalLabel">Payment Receipt</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body p-0" id="receiptBody">
              <div class="receipt-container p-5">
                <div class="text-center mb-4">
                  <i class="fas fa-graduation-cap fa-3x text-primary mb-3"></i>
                  <h4 class="font-weight-bold text-uppercase text-primary">Sinar Warisan Tuition Center</h4>
                  <p class="text-muted">123 Education Lane, Knowledge City</p>
                </div>
                <div class="receipt-divider my-4"></div>
                <div class="row mb-2">
                  <div class="col-6 text-muted">Receipt ID</div>
                  <div class="col-6 text-right font-weight-bold text-dark" id="r-id"></div>
                </div>
                <div class="row mb-4">
                  <div class="col-6 text-muted">Date</div>
                  <div class="col-6 text-right font-weight-bold text-dark" id="r-date"></div>
                </div>
                <div class="receipt-details bg-light p-3 rounded mb-4">
                  <div class="row mb-2">
                    <div class="col-6 text-muted">Teacher</div>
                    <div class="col-6 text-right font-weight-bold" id="r-teacher"></div>
                  </div>
                  <div class="row mb-2">
                    <div class="col-6 text-muted">Student</div>
                    <div class="col-6 text-right font-weight-bold" id="r-student"></div>
                  </div>
                  <div class="row">
                    <div class="col-6 text-muted">Class</div>
                    <div class="col-6 text-right font-weight-bold" id="r-class"></div>
                  </div>
                </div>
                <div class="receipt-divider my-4"></div>
                <div class="row align-items-center">
                  <div class="col-6">
                    <h5 class="font-weight-bold text-dark m-0">Total Amount</h5>
                  </div>
                  <div class="col-6 text-right">
                    <h3 class="font-weight-bold text-success m-0" id="r-amount"></h3>
                  </div>
                </div>
                <div class="receipt-divider my-4"></div>
                <div class="text-center mt-4">
                  <p class="text-muted font-italic mb-0">Thank you for your payment!</p>
                  <small class="text-muted">This is a computer-generated receipt.</small>
                </div>
              </div>
            </div>
            <div class="modal-footer bg-light border-top-0">
              <button type="button" class="btn btn-outline-secondary rounded-pill px-4"
                data-dismiss="modal">Close</button>
              <button type="button" class="btn btn-success rounded-pill px-4 shadow-sm" onclick="window.print()">
                <i class="fas fa-print mr-2"></i> Print Receipt
              </button>
            </div>
          </div>
        </div>
      </div>

      <script>
        document.addEventListener('DOMContentLoaded', function () {
          // Set default date to today
          document.getElementById('paymentDate').valueAsDate = new Date();

          const studentInput = document.getElementById('studentSearchInput');
          const studentIdInput = document.getElementById('studentId');
          const suggestionsBox = document.getElementById('studentSuggestions');
          const subjectSelect = document.getElementById('classSubject');
          const donePaymentBtn = document.getElementById('donePaymentBtn');

          let allStudents = [];

          // 1. Fetch All Students and store globally
          fetch('http://localhost:8081/api/student/list', { credentials: 'include' })
            .then(response => response.json())
            .then(data => {
              if (Array.isArray(data)) {
                allStudents = data;
              } else if (data.data && Array.isArray(data.data)) {
                allStudents = data.data;
              } else if (data.content && Array.isArray(data.content)) {
                allStudents = data.content;
              }
              console.log('Students loaded:', allStudents.length);
            })
            .catch(error => console.error('Error fetching students:', error));

          // 2. Search Input Event Listener
          studentInput.addEventListener('input', function () {
            const query = this.value.toLowerCase();
            suggestionsBox.innerHTML = '';

            if (query.length === 0) {
              suggestionsBox.style.display = 'none';
              return;
            }

            const filteredStudents = allStudents.filter(student =>
              student.name.toLowerCase().includes(query)
            );

            if (filteredStudents.length > 0) {
              filteredStudents.forEach(student => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = student.name;
                item.addEventListener('click', function () {
                  selectStudent(student);
                });
                suggestionsBox.appendChild(item);
              });
              suggestionsBox.style.display = 'block';
            } else {
              const noResult = document.createElement('div');
              noResult.className = 'suggestion-item text-muted font-italic';
              noResult.textContent = 'No student found';
              noResult.style.cursor = 'default';
              suggestionsBox.appendChild(noResult);
              suggestionsBox.style.display = 'block';
            }
          });

          // Clear ID when user modifies text, forcing re-selection
          studentInput.addEventListener('input', function () {
            studentIdInput.value = ''; // Invalidates current selection
            subjectSelect.value = '';
            document.getElementById('amount').value = '';
            donePaymentBtn.disabled = true;
          });

          // Hide suggestions when clicking outside
          document.addEventListener('click', function (e) {
            if (!studentInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
              suggestionsBox.style.display = 'none';
            }
          });

          // Function to handle student selection
          function selectStudent(student) {
            studentInput.value = student.name;
            studentIdInput.value = student.id;
            suggestionsBox.style.display = 'none';

            // Trigger subject fetch
            fetchStudentSubjects(student.id);
          }

          // 3. Fetch Subjects when Student is Selected
          function fetchStudentSubjects(studentId) {
            // Reset dependent fields
            subjectSelect.value = '';
            donePaymentBtn.disabled = true; // Disable button by default

            if (!studentId) return;

            fetch(`http://localhost:8081/api/student/list/studentSubject/${studentId}`, { credentials: 'include' })
              .then(response => response.json())
              .then(res => {
                let subjects = [];
                if (res.data && Array.isArray(res.data)) {
                  subjects = res.data;
                } else if (Array.isArray(res)) {
                  subjects = res;
                }

                console.log(subjects);

                if (subjects.length === 0) {
                  subjectSelect.value = 'Student does not take any subject';
                  document.getElementById('amount').value = ''; // Reset amount
                  // Button remains disabled
                } else {
                  let subjectList = subjects.map(sub => sub.subjectName).join('\n');
                  subjectSelect.value = subjectList;

                  // Calculate Price: RM 50 per subject
                  const price = subjects.length * 50;
                  document.getElementById('amount').value = price;

                  donePaymentBtn.disabled = false; // Enable button if subjects exist
                }
              })
              .catch(error => {
                console.error('Error fetching student subjects:', error);
                subjectSelect.value = 'Error loading subjects';
                document.getElementById('amount').value = '';
              });
          }

          donePaymentBtn.addEventListener('click', function () {
            // Get values
            var studentName = studentInput.value;
            var studentId = studentIdInput.value;

            var subjectSelect = document.getElementById('classSubject');
            var subject = subjectSelect.value;
            var teacher = "-"; // Teacher info is now embedded in the subject list

            var amount = document.getElementById('amount').value;
            var date = document.getElementById('paymentDate').value;

            // Simple validation
            if (!studentId) {
              showModal('Validation Error', 'Student name not found. Please select a valid student from the list.', 'error');
              return;
            }

            if (!teacher || !subject || !amount || !date) {
              showModal('Validation Error', 'Please select a valid student and fill in all fields', 'warning');
              return;
            }

            const payload = {
              studentId: parseInt(studentId),
              date: date,
              amount: parseFloat(amount),
              status: "success"
            };

            // Send Payment Data to API
            fetch('http://localhost:8081/api/payment/pay', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(payload),
              credentials: 'include'
            })
              .then(response => {
                if (response.ok) {
                  // Generate Receipt ID (random for demo)
                  var receiptId = 'REC-' + Math.floor(Math.random() * 1000000);

                  // Populate Receipt
                  document.getElementById('r-id').textContent = receiptId;
                  document.getElementById('r-date').textContent = date;
                  document.getElementById('r-teacher').textContent = teacher;
                  document.getElementById('r-student').textContent = studentName;
                  document.getElementById('r-class').textContent = subject;
                  document.getElementById('r-amount').textContent = 'RM ' + parseFloat(amount).toFixed(2);

                  // Show Modal
                  $('#receiptModal').modal('show');
                } else {
                  showModal('Error', 'Failed to record payment. Please try again.', 'error');
                }
              })
              .catch(error => {
                console.error('Error recording payment:', error);
                showModal('Error', 'An error occurred while recording the payment.', 'error');
              });
          });
        });
      </script>
      <style>
        /* body {
          font-family: 'Poppins', sans-serif;
        } */

        .bg-gradient-primary {
          background: linear-gradient(45deg, #007bff, #6610f2);
        }

        .card {
          border: none;
          transition: transform 0.3s ease;
        }

        .card:hover {
          transform: translateY(-5px);
        }

        .form-control {
          border-radius: 0.25rem;
        }

        .form-control:focus {
          box-shadow: none;
          border-color: #6610f2;
        }

        .input-group-text {
          background-color: #f8f9fa;
          border-color: #ced4da;
        }

        .receipt-container {
          background: #fff;
          border-radius: 15px;
        }

        .receipt-divider {
          height: 2px;
          background: repeating-linear-gradient(to right, #e9ecef 0, #e9ecef 10px, transparent 10px, transparent 15px);
        }

        @media print {
          body * {
            visibility: hidden;
          }

          #receiptModal,
          #receiptModal * {
            visibility: visible;
          }

          #receiptModal {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background: white;
          }

          .modal-footer {
            display: none;
            /* Hide buttons in print */
          }

          .receipt-container {
            border: 2px solid #000;
          }
        }

        /* Suggestions List Styles */
        .suggestions-list {
          position: absolute;
          top: 100%;
          left: 0;
          right: 0;
          z-index: 1000;
          background: white;
          border: 1px solid #ced4da;
          border-top: none;
          max-height: 200px;
          overflow-y: auto;
          display: none;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          border-radius: 0 0 0.25rem 0.25rem;
        }

        .suggestion-item {
          padding: 10px 15px;
          cursor: pointer;
          border-bottom: 1px solid #f0f0f0;
          color: #333;
        }

        .suggestion-item:last-child {
          border-bottom: none;
        }

        .suggestion-item:hover {
          background-color: #f8f9fa;
          color: #007bff;
        }

        .suggestion-item.text-muted:hover {
          background-color: white;
          color: #6c757d;
        }

        /* Dark Mode Support */
        .dark-mode .suggestions-list {
          background-color: #3f474e;
          border-color: #6c757d;
        }

        .dark-mode .suggestion-item {
          border-bottom-color: #4b545c;
          color: #fff;
        }

        .dark-mode .suggestion-item:hover {
          background-color: #4b545c;
          color: #fff;
        }

        .dark-mode .suggestion-item.text-muted {
          color: #adb5bd !important;
        }

        .dark-mode .suggestion-item.text-muted:hover {
          background-color: #3f474e;
          color: #adb5bd !important;
        }
      </style>
    </div>
    <!-- /.content-wrapper -->

    <!-- Control Sidebar -->
    <aside class="control-sidebar control-sidebar-dark">
      <!-- Control sidebar content goes here -->
      <div class="p-3">
        <h5>Title</h5>
        <p>Sidebar content</p>
      </div>
    </aside>
    <!-- /.control-sidebar -->

    <!-- Main Footer -->
    <footer class="main-footer">
      <strong>Copyright &copy; 2025-2030 <a href="">Sinar Warisan</a>.</strong>
      All rights reserved.
      <div class="float-right d-none d-sm-inline-block">
        <b>Version</b> 3.2.0
      </div>
    </footer>
  </div>
  <!-- ./wrapper -->

  <!-- REQUIRED SCRIPTS -->

  <!-- jQuery -->
  <script src="../../plugins/jquery/jquery.min.js"></script>
  <!-- Bootstrap 4 -->
  <script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- AdminLTE App -->
  <script src="../../dist/js/adminlte.min.js"></script>
  <!-- Global Modal -->
  <script src="../global-modal.js"></script>
  <script>
    $(function () {
      // Load Sidebar
      $("#sidebar-container").load("sidebar.html", function () {
        $("#nav-payment").addClass("active");
      });
      // Load Navbar
      $("#navbar-container").load("navbar.html");
    });
  </script>
</body>

</html>